{% extends "base.html" %}

{% block title %}Chat - Antlers{% endblock %}

{% block extra_css %}
<style>
    .chat-container {
        height: 60vh;
        overflow-y: auto;
        padding: 1rem;
        background-color: #f8f9fa;
        border-radius: 0.5rem;
        margin-bottom: 1rem;
    }
    
    .message {
        max-width: 75%;
        margin-bottom: 1rem;
        padding: 0.75rem 1rem;
        border-radius: 1rem;
        position: relative;
    }
    
    .message-outgoing {
        background-color: var(--primary-color, #2D68C4);
        color: white;
        margin-left: auto;
        border-bottom-right-radius: 0.25rem;
    }
    
    .message-incoming {
        background-color: white;
        border: 1px solid #dee2e6;
        margin-right: auto;
        border-bottom-left-radius: 0.25rem;
    }
    
    .message-time {
        font-size: 0.7rem;
        margin-top: 0.25rem;
        opacity: 0.8;
    }
    
    .sender-name {
        font-weight: bold;
        margin-bottom: 0.25rem;
    }
    
    .message-form textarea {
        border-radius: 1.5rem;
        padding: 0.75rem 1.25rem;
    }
    
    .item-details {
        border-left: 4px solid var(--primary-color, #2D68C4);
        padding-left: 1rem;
    }
    
    .chat-date-divider {
        text-align: center;
        position: relative;
        margin: 1.5rem 0;
    }
    
    .chat-date-divider:before {
        content: '';
        position: absolute;
        top: 50%;
        left: 0;
        right: 0;
        height: 1px;
        background-color: #dee2e6;
        z-index: 1;
    }
    
    .chat-date-divider span {
        background-color: #f8f9fa;
        padding: 0 1rem;
        position: relative;
        z-index: 2;
        font-size: 0.8rem;
        color: #6c757d;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center mt-4">
        <div class="col-lg-10">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="mb-0">
                            {% if current_user.id == borrow_request.borrower_id %}
                                Chat with {{ borrow_request.lender_user.username }} (Lender)
                            {% else %}
                                Chat with {{ borrow_request.borrower_user.username }} (Borrower)
                            {% endif %}
                        </h4>
                    </div>
                    <div>
                        <a href="{{ url_for('borrow_details', borrow_id=borrow_request.id) }}" class="btn btn-light btn-sm">
                            <i class="fas fa-info-circle me-1"></i>Borrow Details
                        </a>
                    </div>
                </div>
                
                <div class="card-body">
                    <!-- Item Details -->
                    <div class="item-details mb-4">
                        <div class="d-flex align-items-center">
                            {% if borrow_request.accessory.image %}
                            <div class="me-3">
                                <img src="{{ url_for('static', filename=borrow_request.accessory.image.replace('\\', '/')) }}" 
                                     alt="{{ borrow_request.accessory.name }}" 
                                     class="rounded" 
                                     style="width: 60px; height: 60px; object-fit: cover;">
                            </div>
                            {% endif %}
                            <div>
                                <h5 class="mb-1">{{ borrow_request.accessory.name }}</h5>
                                <div class="d-flex small text-muted">
                                    <div class="me-3">
                                        <i class="fas fa-map-marker-alt me-1"></i>{{ borrow_request.pickup_location }}
                                    </div>
                                    <div>
                                        <i class="fas fa-calendar me-1"></i>{{ borrow_request.pickup_datetime.strftime('%d %b %Y, %I:%M %p') if borrow_request.pickup_datetime else 'Not specified' }}
                                    </div>
                                </div>
                                <span class="badge bg-{{ borrow_request.status == 'pending' and 'warning' or (borrow_request.status == 'approved' and 'success' or (borrow_request.status == 'delivered' and 'info' or 'secondary')) }} mt-2">
                                    <i class="fas fa-{{ borrow_request.status == 'pending' and 'clock' or (borrow_request.status == 'approved' and 'check' or (borrow_request.status == 'delivered' and 'box' or 'times')) }} me-1"></i>
                                    {{ borrow_request.status.capitalize() }}
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Chat Messages -->
                    <div class="chat-container" id="chatContainer">
                        {% set last_date = None %}
                        {% for message in messages %}
                            {% set message_date = message.timestamp.date() %}
                            
                            {% if last_date != message_date %}
                                <div class="chat-date-divider">
                                    <span>
                                        {% if message_date == today %}
                                            Today
                                        {% elif message_date == yesterday %}
                                            Yesterday
                                        {% else %}
                                            {{ message.timestamp.strftime('%d %b %Y') }}
                                        {% endif %}
                                    </span>
                                </div>
                                {% set last_date = message_date %}
                            {% endif %}
                            
                            <div class="message {{ 'message-outgoing' if message.sender_id == current_user.id else 'message-incoming' }}">
                                {% if message.sender_id != current_user.id %}
                                <div class="sender-name">{{ message.sender.username }}</div>
                                {% endif %}
                                <div class="message-content">{{ message.message }}</div>
                                <div class="message-time text-end">
                                    {{ message.timestamp.strftime('%I:%M %p') }}
                                    {% if message.sender_id == current_user.id %}
                                        {% if message.is_read %}
                                        <i class="fas fa-check-double ms-1"></i>
                                        {% else %}
                                        <i class="fas fa-check ms-1"></i>
                                        {% endif %}
                                    {% endif %}
                                </div>
                            </div>
                        {% else %}
                            <div class="text-center p-5 text-muted">
                                <i class="fas fa-comments fa-3x mb-3"></i>
                                <h5>No messages yet</h5>
                                <p>Start the conversation by sending a message below.</p>
                            </div>
                        {% endfor %}
                    </div>
                    
                    <!-- Message Form -->
                    <form method="POST" class="message-form">
                        <div class="input-group">
                            <textarea 
                                name="message" 
                                class="form-control" 
                                placeholder="Type your message here..." 
                                rows="2" 
                                required
                            ></textarea>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-paper-plane me-2"></i>Send
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chat Welcome Modal -->
<div class="modal fade" id="chatWelcomeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-comments me-2"></i>Chat Started
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="text-center mb-4">
                    <i class="fas fa-handshake fa-3x text-success mb-3"></i>
                    <h4>You can now chat with 
                        {% if current_user.id == borrow_request.borrower_id %}
                            the lender
                        {% else %}
                            the borrower
                        {% endif %}
                    </h4>
                </div>
                <p>Use this chat to:</p>
                <ul class="mb-4">
                    <li>Coordinate pickup/delivery details</li>
                    <li>Ask questions about the item</li>
                    <li>Arrange for return when ready</li>
                </ul>
                <p class="text-muted small mb-0">This chat will remain active until the item is returned. All messages are deleted when both parties confirm the return.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success px-4" data-bs-dismiss="modal">
                    Start Chatting
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // Scroll to bottom of chat container on page load
    document.addEventListener('DOMContentLoaded', function() {
        var chatContainer = document.getElementById('chatContainer');
        chatContainer.scrollTop = chatContainer.scrollHeight;
        
        // Check if we should show the welcome modal
        {% if show_modal or request.args.get('show_modal') == '1' %}
            var chatWelcomeModal = new bootstrap.Modal(document.getElementById('chatWelcomeModal'));
            chatWelcomeModal.show();
        {% endif %}
    });
</script>
{% endblock %} 